<!doctype html>
<html >
<head>
<script type="text/javascript" src="exif.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.1/angular.min.js"></script>
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<script type="text/javascript" src="angular-base64-upload.js"></script>
</head>
<body >
<p></p>
Upload a local file to read Exif data.
<br/>
<input id="file-input" type="file" src="" onchange="loadImageFileAsURL()"/>
<br/><br/>
<p></p>
Degrees:

<input id='alpha' type="number" min="0" max="359" value="0" onchange="loadImageFileAsURL()">
</br>
<p></p>
Before:
<img id="img1" src=""  style="width: 25%; height:25% " />
<br/>

<br/>
After:
<img id="image-reset" src="" style="width: 25%; height:25% "/>




<p>File Contents as DataURL:</p>
    <textarea id="textAreaFileContents" style="width:640;height:240" ></textarea>

<script>

if (window.DeviceOrientationEvent) {
 console.log("DeviceOrientation is supported");
}
else{
	console.log("No support");
}

resetImage = document.getElementById("image-reset");
originalImage = document.getElementById("img1");


var thatImageRotatate = getImageOrientation();

console.log(thatImageRotatate);
console.log('orginal sause 1 ' + originalImage.src);


document.getElementById("img1").onclick = function() {
	originalImage = document.getElementById("file-input");
    EXIF.getData(this, function() {
        make = EXIF.getTag(this, "Make");
            model = EXIF.getTag(this, "Model");
        alert("I was taken by a " + make + " " + model);
         imageOrientation = EXIF.getTag(this,"Orientation");
         console.log('orignal image Orientation ' + imageOrientation);       
    });
}


document.getElementById("file-input").onchange = function(e) {
    EXIF.getData(e.target.files[0], function() {
        alert(EXIF.pretty(this));
        
        var imageOrientation = EXIF.getTag(this,"Orientation");
       
        console.log('imageOrientation '+imageOrientation);
        console.log( this);
        
        img1.src = this.name;
        
        console.log('image 1 sause ' + img1.src);

        loadImageFileAsURL();
    });
}



function getImageOrientation(){
		var thisOne = document.getElementById("file-input");
		EXIF.getData(thisOne, function() {
        
         imageOrientation = EXIF.getTag(this,"Orientation");
         console.log('in function getImageOrientation ' + imageOrientation);

         
        
    });

}

function loadImageFileAsURL(){
	console.log('things');
	var newBeforeImg = document.getElementById("img1");
	console.log(  newBeforeImg.src);
    var filesSelected = document.getElementById("file-input").files;
    var raTilt = document.getElementById("alpha").value;
    console.log('alpha');
    console.log(raTilt);
    console.log('filesSelected');
    console.log( filesSelected);
    
    if (filesSelected.length > 0)
    {
        var fileToLoad = filesSelected[0];
 
        var fileReader = new FileReader();
 
        fileReader.onload = function(fileLoadedEvent) 
        {
            var textAreaFileContents = document.getElementById
            (
                "textAreaFileContents"
            );
     		

            textAreaFileContents.innerHTML = fileLoadedEvent.target.result;
            var baser64 = fileLoadedEvent.target.result;
            originalImage.src = fileLoadedEvent.target.result;
            console.log('baser64' + fileLoadedEvent.target.result);
            
           console.log(filesSelected[0].exifdata.Orientation);
           var filesSelectedOrientation = filesSelected[0].exifdata.Orientation;

            //
            EXIF.getData(filesSelected, function() {
        
		         imageOrientation = EXIF.getTag(filesSelected,"Orientation");
		         console.log('in function getImageOrientation ' + imageOrientation);

		         
		        
		    });

            //
            resetOrientation(raTilt,originalImage.src, filesSelectedOrientation, function(resetBase64Image) {
				resetImage.src = resetBase64Image;


			});
        };
 
        fileReader.readAsDataURL(fileToLoad);


    }
}

function resetOrientation(cameraTilt,srcBase64, srcOrientation, callback) {
	var img = new Image();	

	img.onload = function() {
  	var width = img.width,
    		height = img.height,
        canvas = document.createElement('canvas'),
	  		ctx = canvas.getContext("2d");
		
     
    // set proper canvas dimensions before transform & export
		if ([5,6,7,8].indexOf(srcOrientation) > -1) {
    	canvas.width = height;
      canvas.height = width;
    } else {
    	canvas.width = width;
      canvas.height = height;
    }
	
  	// transform context before drawing image
    console.log('srcOrientation ' + srcOrientation);

    console.log('camera Orientation ' + cameraTilt);
   


    switch (cameraTilt){

    	case '0':
    		console.log('gamma: 0');
			switch (srcOrientation) {// portrait camera up right'
			  case 1: ctx.transform(1, 0, 0, 1, 0, 0); break;//works
		      case 2: ctx.transform(-1, 0, 0, 1, width, 0); break;
		      case 3: ctx.transform(-1, 0, 0, -1, width, height ); break;//works
		      case 4: ctx.transform(1, 0, 0, -1, 0, height ); break;
		      case 5: ctx.transform(0, 1, 1, 0, 0, 0); break;
		      case 6: ctx.transform(0, 1, -1, 0, height , 0); break;//works
		      case 7: ctx.transform(0, -1, -1, 0, height , width); break;
		      case 8: ctx.transform(0, -1, 1, 0, 0, width); break;//works
		      default: ctx.transform(1, 0, 0, 1, 0, 0);
		    }
		   break;
		case '90':
    		console.log('gamma: 90');
			switch (srcOrientation) {// clockwise 90 degrees'
			  case 1: ctx.transform(0, -1, 1, 0, 0, width); break;//works?
		      case 2: ctx.transform(-1, 0, 0, 1, width, 0); break;
		      case 3: ctx.transform(0, -1, 1, 0, 0, width); break;//works
		      case 4: ctx.transform(1, 0, 0, -1, 0, height ); break;
		      case 5: ctx.transform(0, 1, 1, 0, 0, 0); break;
		      case 6: ctx.transform(-1, 0, 0, -1, width, height); break;//works 
		      case 7: ctx.transform(0, -1, -1, 0, height , width); break;
		      case 8: ctx.transform(1, 0, 0, 1, 0, 0); break;
		      default: ctx.transform(1, 0, 0, 1, 0, 0);
		    }
		   break;
		case '180':
    		console.log('gamma: 180');
			switch (srcOrientation) {// upside down'
			  case 1: ctx.transform(-1, 0, 0, -1, width, height ); break;//works?
		      case 2: ctx.transform(-1, 0, 0, 1, width, 0); break;
		      case 3: ctx.transform(1, 0, 0, 1, 0, 0); break;//works
		      case 4: ctx.transform(1, 0, 0, -1, 0, height ); break;
		      case 5: ctx.transform(0, 1, 1, 0, 0, 0); break;
		      case 6: ctx.transform(0, -1, -1, 0, height , width); break;//works
		      case 7: ctx.transform(0, -1, -1, 0, height , width); break;
		      case 8: ctx.transform(0, 1, -1, 0, height , 0); break;//works
		      default: ctx.transform(1, 0, 0, 1, 0, 0);
		    }
		   break;
		 case '270':
    		console.log('gamma: 270');
			switch (srcOrientation) {// counterclockwise 90 degrees'
			  case 1: ctx.transform(0, 1, -1, 0, height , 0); break;//works?
		      case 2: ctx.transform(-1, 0, 0, 1, width, 0); break;
		      case 3: ctx.transform(0, 1, -1, 0, height , 0); break;//works
		      case 4: ctx.transform(1, 0, 0, -1, 0, height ); break;
		      case 5: ctx.transform(0, 1, 1, 0, 0, 0); break;
		      case 6: ctx.transform(1, 0, 0, 1, 0, 0); break;//works
		      case 7: ctx.transform(0, -1, -1, 0, height , width); break;
		      case 8: ctx.transform(-1, 0, 0, -1, width, height ); break;//works
		      default: ctx.transform(1, 0, 0, 1, 0, 0);
		    }
		   break;
		default: 
			console.log('defaultly');

	}

		// draw image
    ctx.drawImage(img, 0, 0);

		// export base64
		callback(canvas.toDataURL());
  };

	img.src = srcBase64;
}


 console.log('orginal sause 2 ' + originalImage.src);
// resetOrientation(originalImage.src, 1, function(resetBase64Image) {
// 	resetImage.src = resetBase64Image;
// }
;

</script>



</body>




</html>